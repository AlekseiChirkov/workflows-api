# Idempotency Strategy

## Why Idempotency Is Required

This system is built on top of Google Pub/Sub, which provides **at-least-once delivery**.
This means that the same event **can be delivered multiple times** under normal conditions:

- ACK timeout
- consumer crash
- redeploy
- network issues

Duplicate delivery is **expected behavior**, not an error.

---

## Idempotency Key

Each event contains a unique identifier:

- `event_id` (UUID)

This field is generated by the producer and **must be globally unique**.

`event_id` is used as the **idempotency key**.

---

## Idempotent Processing Rules

For each incoming event:

1. Check if `event_id` was already processed
2. If YES:
   - Do NOT re-run business logic
   - ACK the message immediately
3. If NO:
   - Execute business logic
   - Persist `event_id` as processed
   - ACK the message

---

## Storage for Processed Events

Processed event IDs must be stored in a durable storage:

Possible options:
- Database table (recommended)
- Redis with TTL
- Key-value store

Minimal schema example:

processed_events(event_id UUID PRIMARY KEY, processed_at TIMESTAMP)

---

## Retention and Cleanup

Processed events **do not need to be stored forever**.

Recommended strategies:
- TTL-based cleanup (e.g. 7â€“30 days)
- Periodic cleanup job

Retention period must be **longer than Pub/Sub retry window**.

---

## Exactly-Once Semantics

Exactly-once delivery is **not assumed**.

Instead, the system achieves **effectively-once processing** by:
- at-least-once delivery
- idempotent consumers

This approach is:
- cheaper
- more reliable
- easier to reason about

---

## Error Handling Strategy

Errors are classified into two categories:

### Retryable errors (NACK)
- Temporary database outages
- Network timeouts
- External service unavailable

### Non-retryable errors (ACK)
- Invalid payload
- Business rule violations
- Missing domain entities

Non-retryable errors must be:
- logged
- monitored
- optionally sent to DLQ

---

## Key Principles

- Duplicate delivery is normal
- Idempotency is mandatory
- NACK only when retry makes sense
- DLQ is for diagnostics, not retries
- Exactly-once is an illusion