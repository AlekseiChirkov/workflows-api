## DLQ / Execution Log Investigation Runbook

### 1. Сигналы инцидента
1. **Алерт из Prometheus**
   - `worker_dlq_total` — резкий рост по конкретному `workflow_id`.
   - `worker_failure_total` растёт быстрее, чем `worker_success_total`.
2. **Ошибки в поддержке** — клиенты сообщают, что события не дошли до действия.
3. **DevOps мониторинг** — спайк в `worker_action_duration_seconds` или отсутствие новых логов.

### 2. Первичная диагностика
1. Зафиксируйте `workflow_id`, `trace_id`, временной диапазон.
2. Проверьте метрики:
   ```bash
   curl http://worker-host:8000/metrics | grep worker_dlq_total
   ```
3. Снимите выдержку логов по `trace_id` (structured logging уже содержит trace_id, workflow_id, attempts).

### 3. Работа с Execution Logs API
**Запрос последних записей по workflow:**
```bash
curl -H "X-API-Key: $API_KEY" \
  "https://api.host/execution-logs?workflow_id=<uuid>&limit=50"
```

**Фильтр по trace_id:**
```bash
curl -H "X-API-Key: $API_KEY" \
  "https://api.host/execution-logs?trace_id=<trace>"
```

**DLQ-записи:**
```bash
curl -H "X-API-Key: $API_KEY" \
  "https://api.host/execution-logs?queued_to_dlq=true&limit=100"
```

Поля записи:
- `status`, `retryable`, `queued_to_dlq`, `attempts`.
- `last_error` — последняя попытка.
- `payload_snapshot` — исходные данные события.
- `action_duration_ms` — время работы действия (искать таймауты/зависания).

### 4. Решение
| Сценарий | Действия |
| --- | --- |
| **Бизнес-ошибка (не retryable)** | Исправить входные данные/конфигурацию. Перезапускать событие не нужно, но можно пересоздать правильно. |
| **Инфраструктурная ошибка (retryable, но превысили MAX_ATTEMPTS)** | Найти корень (БД/сервис недоступен), устранить, затем вручную репаблишить события. |
| **Длительные таймауты** | Сравнить `action_duration_ms` с таймаутом, увеличить или оптимизировать действие. |

### 5. Репаблиш / повтор события
1. Найти запись, убедиться, что входной payload корректен.
2. При необходимости внести правки (например, обновить данные клиента).
3. Отправить payload в исходный Pub/Sub topic (или через CLI/скрипт).
4. Либо создать служебный endpoint/скрипт для реинжеста — зафиксировать в тикете.

### 6. Коммуникации
1. **Описание проблемы** — какой workflow, когда началось, сколько событий затронуто.
2. **Причина** — бизнес/инфра/таймаут.
3. **Решение** — что сделано, что осталось, нужен ли репаблиш.
4. **Профилактика** — например, добавить валидацию payload, увеличить таймаут, оптимизировать действие.

### 7. Чеклист завершения
- [ ] Метрики вернулись к норме (`dlq_total` не растёт).
- [ ] Execution Logs не показывают новых DLQ для данного workflow.
- [ ] Клиент/владелец подтверждён об устранении.
- [ ] Тикет/инцидент закрыт с пост-мортем.
