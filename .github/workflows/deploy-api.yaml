name: Deploy API

on:
  push:
    branches:
      - main
    paths:
      - "src/**"
      - "!src/worker/**"
      - "docker/api.Dockerfile"
      - "requirements.txt"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker auth
        run: gcloud auth configure-docker --quiet

      - name: Build Docker image (API)
        run: |
          docker build \
            -f docker/api.Dockerfile \
            -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/workflow-api:latest .

      - name: Push Docker image (API)
        run: |
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/workflow-api:latest

      - name: Start Cloud SQL Proxy
        run: |
          curl -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.10.0/cloud-sql-proxy.linux.amd64
          chmod +x cloud-sql-proxy
          echo '${{ secrets.GCP_SA_KEY }}' > sa-key.json
          ./cloud-sql-proxy ${{ secrets.INSTANCE_CONNECTION_NAME }} \
            --credentials-file=sa-key.json &

      - name: Run migrations
        env:
          API_KEY: ${{ secrets.API_KEY }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: alembic upgrade head

      - name: Deploy to Cloud Run (API)
        run: |
          gcloud run deploy workflow-api \
            --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/workflow-api:latest \
            --region ${{ secrets.GCP_REGION }} \
            --platform managed \
            --service-account cloud-run-api-sa@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com \
            --allow-unauthenticated \
            --add-cloudsql-instances ${{ secrets.INSTANCE_CONNECTION_NAME }}
